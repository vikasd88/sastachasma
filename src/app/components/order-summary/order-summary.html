<div class="order-summary-container">
  <!-- Show server order details if available, otherwise show local order details -->
  <div class="order-summary">
    <ng-container *ngIf="!loading; else loadingTemplate">
      <div *ngIf="orderDetails; else errorTemplate"> <!-- Changed activeOrderDetails to orderDetails -->
        <div class="order-confirmation">
          <div class="success-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <h1>Order Confirmed!</h1>
          <p class="order-id">Order #{{ orderDetails.orderNumber }}</p> <!-- Changed orderId to orderNumber -->
          <p class="confirmation-message">Thank you for your purchase. We've received your order and it's being processed.</p>

          <div class="delivery-info">
            <h3>Estimated Delivery</h3>
            <p class="delivery-date">{{ getEstimatedDeliveryDate() }}</p>
          </div>
        </div>

        <div class="order-details">
          <h2>Order Summary</h2>
          <div class="order-items">
            <div class="order-item" *ngFor="let item of orderDetails.items"> <!-- Changed activeOrderDetails to orderDetails -->
              <div class="item-image-container">
                <img [src]="getProductImage(item)" [alt]="item.name" class="item-image" (error)="$event.target.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNEOEQ4RDgiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSI4LjUiIGN5PSI4LjUiIHI9IjEuNSI+PC9jaXJjbGU+Cjxwb2x5bGluZSBwb2ludHM9IjIxIDE1IDE2IDEwIDUgMjEiPjwvc3ZnPg=='"/> <!-- Updated error fallback -->
                <span class="item-quantity" *ngIf="item.quantity > 1">{{ item.quantity }}</span>
              </div>
              <div class="item-details">
                <h4>{{ item.name || 'Unknown Product' }}</h4>

                <!-- Lens Details (if available) -->
                <div *ngIf="item.lensId" class="lens-details">
                  <p><strong>Lens Type:</strong> {{ item.lensType }}</p>
                  <p><strong>Material:</strong> {{ item.lensMaterial }}</p>
                  <p><strong>Prescription:</strong> {{ item.lensPrescriptionRange }}</p>
                  <p><strong>Coating:</strong> {{ item.lensCoating }}</p>
                  <p><strong>Lens Price:</strong> ₹{{ item.lensPrice | currency:'INR':'symbol':'1.2-2' }}</p>
                </div>

                <!-- Item Total -->
                <div class="price-row item-total">
                  <strong>Item Total</strong>
                  <strong>₹{{ calculateItemSubtotal(item) | currency:'INR':'symbol':'1.2-2' }}</strong>
                </div>
              </div>
            </div>
          </div>

          <div class="order-totals">
            <div class="total-row">
              <span>Subtotal ({{ orderDetails.items.length || 0 }} items)</span> <!-- Changed activeOrderDetails to orderDetails -->
              <span>₹{{ orderDetails.subtotal | currency:'INR':'symbol':'1.2-2' }}</span> <!-- Changed calculateOrderSubtotal() to orderDetails.subtotal -->
            </div>
            <div class="total-row">
              <span>Shipping Fee</span> <!-- Changed to Shipping Fee -->
              <span>₹{{ orderDetails.shippingFee | currency:'INR':'symbol':'1.2-2' }}</span> <!-- Changed to orderDetails.shippingFee -->
            </div>
            <div class="total-row">
              <span>Tax</span>
              <span>₹{{ orderDetails.tax | currency:'INR':'symbol':'1.2-2' }}</span> <!-- Changed to orderDetails.tax -->
            </div>
            <div class="total-row grand-total">
              <span>Total Amount</span>
              <span>₹{{ orderDetails.totalAmount | currency:'INR':'symbol':'1.2-2' }}</span> <!-- Changed activeOrderDetails.total to orderDetails.totalAmount -->
            </div>
          </div>

          <div class="shipping-details">
            <div class="shipping-address">
              <h3>Billing Address</h3> <!-- Changed to Billing Address -->
              <p>{{ orderDetails.billingAddress.street }}</p>
              <p>{{ orderDetails.billingAddress.city }}, {{ orderDetails.billingAddress.state }} {{ orderDetails.billingAddress.postalCode }}</p>
              <p>{{ orderDetails.billingAddress.country }}</p>
              <p>Phone: {{ orderDetails.billingAddress.phone }}</p>
            </div>
            <div class="payment-method">
              <h3>Payment Information</h3>
              <p>Method: {{ getPaymentMethod() }}</p>
              <p>Status: {{ orderDetails.paymentStatus }}</p>
            </div>
          </div>

          <div class="action-buttons">
            <button (click)="continueShopping()" class="btn btn-primary">Continue Shopping</button>
            <button (click)="trackOrder()" class="btn btn-outline">Track Order</button>
          </div>
        </div>
      </div>

      <ng-template #errorTemplate>
        <div class="loading-error">
          <div class="error-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <h2>Order Not Found</h2>
          <p>{{ error || 'Unable to load order details. Please try again later.' }}</p>
          <button (click)="router.navigate(['/'])" class="btn btn-primary">Back to Home</button>
        </div>
      </ng-template>
    </ng-container>

    <ng-template #loadingTemplate>
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading order details...</p>
      </div>
    </ng-template>
  </div>
</div>
